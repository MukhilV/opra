{% extends 'polls/base.html' %}

{% block extra_head %}
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>

<script>
/*!
 * jQuery UI Touch Punch 0.2.3
 *
 * Copyright 2011â€“2014, Dave Furfero
 * Dual licensed under the MIT or GPL Version 2 licenses.
 *
 * Depends:
 *  jquery.ui.widget.js
 *  jquery.ui.mouse.js
 */
!function(a){function f(a,b){if(!(a.originalEvent.touches.length>1)){a.preventDefault();var c=a.originalEvent.changedTouches[0],d=document.createEvent("MouseEvents");d.initMouseEvent(b,!0,!0,window,1,c.screenX,c.screenY,c.clientX,c.clientY,!1,!1,!1,!1,0,null),a.target.dispatchEvent(d)}}if(a.support.touch="ontouchend"in document,a.support.touch){var e,b=a.ui.mouse.prototype,c=b._mouseInit,d=b._mouseDestroy;b._touchStart=function(a){var b=this;!e&&b._mouseCapture(a.originalEvent.changedTouches[0])&&(e=!0,b._touchMoved=!1,f(a,"mouseover"),f(a,"mousemove"),f(a,"mousedown"))},b._touchMove=function(a){e&&(this._touchMoved=!0,f(a,"mousemove"))},b._touchEnd=function(a){e&&(f(a,"mouseup"),f(a,"mouseout"),this._touchMoved||f(a,"click"),e=!1)},b._mouseInit=function(){var b=this;b.element.bind({touchstart:a.proxy(b,"_touchStart"),touchmove:a.proxy(b,"_touchMove"),touchend:a.proxy(b,"_touchEnd")}),c.call(b)},b._mouseDestroy=function(){var b=this;b.element.unbind({touchstart:a.proxy(b,"_touchStart"),touchmove:a.proxy(b,"_touchMove"),touchend:a.proxy(b,"_touchEnd")}),d.call(b)}}}(jQuery);
</script>

<style>
  #sortable1,#sortable2 { list-style-type: none; margin: 0; padding: 10px;  background-color: #eee; }
  #sortable1 li, #sortable2 li { display:block; margin: 5px 5px 5px 5px; padding: 5px; }
     
	 
  html>body #sortable li { height: 1.5em; line-height: 0em; }
  .ui-state-highlight { height: 1.5em; line-height: 0em; background-color: #aaa;}
  .greybackground{background-color: #aaa;}
        
  .cliente{
	 margin: 15px;
	border: #cdcdcd medium solid;
	border-radius: 10px;
	-moz-border-radius: 10px;
	-webkit-border-radius: 10px;
	}
	
	button:hover .greencolor{
		color:darkgreen;
	}

  </style>

<script>

function submitPref(){
	var prefcolumn = $('#sortable1');
	var order = prefcolumn.sortable("toArray");
    $('#pref_order').val(order.join(","));
    $('#pref_order').submit();
};

function moveToPref(obj) {
	var time = 100
	var prefcolumn = $('#sortable1');
	var currentli = document.getElementById(obj.id);
	jQuery("#"+obj.id).addClass("greybackground");
	setTimeout(function () {	
		prefcolumn.append(currentli);
		jQuery("#"+obj.id).removeClass("greybackground",time*2);
		prefcolumn.sortable('refresh');

    }, time)
	
};

function moveAll() {
	var time = 100
	var ul = document.getElementById('sortable2');
	var items = ul.getElementsByTagName("li");
	var len = items.length
	var prefcolumn = $('#sortable1');
	for (var i = 0; i < len; i++) {
		jQuery("#"+items[i].id).addClass("greybackground");			
	}
	setTimeout(function () {	
		for (var i = 0; i < len; i++) {
			prefcolumn.append(items[0]);				
		}
			setTimeout(function () {	
					var ul = document.getElementById('sortable1');
					var items = ul.getElementsByTagName("li");
					var len = items.length
					
					for (var i = 0; i < len; i++) {
						jQuery("#"+items[i].id).removeClass("greybackground",time);			
					}
					prefcolumn.sortable('refresh');		    
			    }, time)
	    }, time)
	

};

$(function() {
    $("#sortable1").sortable({
		placeholder: "ui-state-highlight",
		containment: "parent",
        update: function(event, ui) {
            var order = $("#sortable1").sortable("toArray");
            $('#pref_order').val(order.join(","));
        }
    });    
    
    $("ul.droptrue").sortable({
        connectWith: "ul"
      });
    
    $( "#sortable1, #sortable2" ).disableSelection();
});
</script>

{% endblock %}

{% block content %}



{% if question.status == 2%}
<div class="grid">
    <div class="row">
        <div class="col-md-2" {% if request.flavour == "mobile" %} style="width:20%;display:inline" {% endif %}>
            <a href="{{ question.image }}"><img src="{{ question.image }}" width="128" ></a>
        </div>
        <div class="col-md-3" {% if request.flavour == "mobile" %} style="width:70%;display:inline" {% endif %}>
            <h1 {% if request.flavour == "mobile" %} style="width:70%;display:inline" {% endif %}>{{ question.question_text }}</h1>
            {% if question.question_desc %}
                <p {% if request.flavour == "mobile" %} style="width:70%" {% endif %}>{{ question.question_desc }}</p>
            {% endif %}
            <p {% if request.flavour == "mobile" %} style="width:70%" {% endif %}><b>Created by</b> {{ question.question_owner }}</p>
            <!-- <p>
                <b>Voters: </b>
                {% for voter in question.question_voters.all %}
                    {% if voter == request.user %}
                        <i>{{ voter }}</i>,
                    {% else %}
                        {{ voter }},
                    {% endif %}
                {% endfor %}
            </p> -->
        </div>
    </div>
</div>
<hr />   

{% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}

<div class="row">
<form action="{% url 'polls:vote' question.id %}" method="post">
    {% csrf_token %}
    
    <div class="col-md-6" >
    <div class="panel panel-default">
     	<div class="panel-heading">
        
        	<b>Your preferences:</b> 
        	
		
        <input type="hidden" id="pref_order" name="pref_order" value=""/>
        
       </div> 
       <button type="submit" onclick="submitPref();" style ="border: none; background-color: Transparent;" >
   			 <span class="glyphicon glyphicon-floppy-save greencolor" ></span> 
		</button>
       <div class="panel-body">
        <ul id="sortable1" class="list-group droptrue">
            {% if currentSelection %}
                {% for selection in currentSelection %}
                    {% for item in question.item_set.all %}
                        {% if selection.0 == item %}
                        <li class="list-group-item" onclick = "moveToPref(this)" id="item{{ forloop.counter }}">
                            {% if selection.0.image %}
                                <img class="item" src='/static/items/{{ selection.0.image.url }}'/>
                            {% endif %}
                            {{ selection.0 }}
                        </li>
                        {% endif %}
                    {% endfor %}
                {% endfor %}
            {% endif %}
        </ul>
       </div> 
       <button >
        <a href="/polls/{{ question.id }}/?order=null" class="glyphicon glyphicon-trash redcolor"></a>
        </button>
    </div>
    </div>
    
    
    
        
    <div class="col-md-6" >
    <div class="panel panel-default">
    		<div class="panel-heading">
        <b>Remaining Options:</b> <a onclick = "moveAll(); return false;" class="btn btn-primary" style = "font-size:60%">Move all</a>
        </div>
        <div class="panel-body">
        <ul id="sortable2" class="list-group">
            {% if currentSelection == None %}
                {% for item in question.item_set.all %}
                <li class="list-group-item" onclick = "moveToPref(this)" id="item{{ forloop.counter }}">
                    {% if item.image %}
                        <img class="item" src='/static/items/{{ item.image.url }}'/>
                    {% endif %}
                    {{ item.item_text }}</li>
                {% endfor %}
            {% endif %}
        </ul>
         </div>
    </div>
    </div>
</form>
</div>

{% elif question.status == 1%}

<p>This poll has not started yet.</p>

{% else %}

<p>This poll has ended.</p>

{% endif %}


{% endblock %}