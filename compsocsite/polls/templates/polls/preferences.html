{% extends 'polls/base.html' %}

{% block content %}
    <div class="col-md-12">
        <h1>{{ question.question_text }}</h1>
        <div class="col-md-6">
        <!-- Display most recent vote -->
        {% if question.question_owner == request.user %}
            {% if latest_responses|length > 0 %}
                {% for response in latest_responses %}
                    
                    {% if response.user.first_name == "" %}
                        <b>{{ response.user.username }}</b> (last voted on {{ response.timestamp }}) <br />
                    {% endif %}
                    {% if response.user.first_name != "" %}
                        {{ response.user.first_name}} {{ response.user.last_name }} (<a href="mailto:{{ response.user.email }}">{{ response.user.email }}</a>)
                        (last voted on {{ response.timestamp }}) <br />
                    {% endif %}
                    <ul class="list-group">
                    {% for d in response.dictionary_set.all %}
                        {% for item in d.sorted_values %}
                        <li class="list-group-item"> {{ item.1 }}) {{ item.0 }} </li>
                        {% endfor %}
                    {% endfor %}
                    </ul>
     
                {% endfor %}
                <br />
                {% if previous_responses %}
                <button data-toggle="collapse" data-target="#history" class="btn btn-info">Show/Hide History</button>
                <div id="history" class="collapse">
                    <div class="well">
                    {% for response in previous_responses %}
                        <ul class="list-group">
                            <b>{{ response.user.username }}</b> (last voted on {{ response.timestamp }}) <br /> 
                            {% for d in response.dictionary_set.all %}
                                {% for item in d.sorted_values %}
                            <li class="list-group-item"> ({{ item.1 }}) {{ item.0 }} </li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    {% endfor %}
                    </div>
                </div>
                {% endif %} <!--previous reoinses-->
        
            {% else %} 
                <p>No one has voted on this poll yet.</p>
            {% endif %} <!-- no response-->
            </div>
        {% else %} <!--question.question_owner != request.user-->
            {% if mostRecentResponse %}
                <ul class="list-group">
                    <b>{{ mostRecentResponse.user.username }}</b> (last voted on {{ mostRecentResponse.timestamp }}) <br /> 
                    {% for d in mostRecentResponse.dictionary_set.all %}
                        {% for item in d.sorted_values %}
                    <li class="list-group-item">({{ item.1 }}) {{ item.0 }} </li>
                        {% endfor %}
                    {% endfor %}
                </ul>
                <br />
                {% if history %}
                <button data-toggle="collapse" data-target="#history" class="btn btn-info">Show/Hide History</button>
                <div id="history" class="collapse">
                    <div class="well">
                    {% for response in history %}
                        <ul class="list-group">
                            <b>{{ response.user.username }}</b> (last voted on {{ response.timestamp }}) <br /> 
                            {% for d in response.dictionary_set.all %}
                                {% for item in d.sorted_values %}
                            <li class="list-group-item">   {{ item.1 }}) {{ item.0 }} </li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% else %}
                <p>You haven't voted on this poll yet.</p>
            {% endif %}
        {% endif %}
            
        {% if question.question_owner != request.user %}
            <!-- Display other user votes -->
            {% if question.display_pref == 1 %}
                <p>{{latest_responses|length}} / {{question.question_voters.count}} have voted.</p>
                <p>The owner allows everyone to see all votes cast.</p>
                {% for response in latest_responses %}
                    {% if response.user != request.user %}
                        <ul class="list-group">
                            <b>{{ response.user.username }}</b> (last voted on {{ response.timestamp }}) <br /> 
                            {% for d in response.dictionary_set.all %}
                                {% for item in d.sorted_values %}
                            <li class="list-group-item"> {{ item.1 }}) {{ item.0 }} </li>
                                {% endfor %}
                            {% endfor %}
                        </ul>
                    {% endif %}
                {% endfor %}
            {% elif question.display_pref == 2 %}
                <p>{{latest_responses|length}} / {{question.question_voters.count}} have voted.</p>
                <p>The following voters have voted on this poll:</p>
                <ul>
                    {% for response in latest_responses %}
                        <li>{{response.user.username}} (last voted on {{ response.timestamp }})</li>
                    {% endfor %}
                </ul>
            {% elif question.display_pref == 3 %}
                <p>{{latest_responses|length}} / {{question.question_voters.count}} have voted.</p>
            {% endif %}
        {% endif %}
        
        <br/>
    </div>
        <a href="{% url 'polls:index' %}"> Return Home</a>
{% endblock %}