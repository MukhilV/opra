<script>
    function add_voter(username){
        $.ajax({
            url: "{% url 'polls:addvoter' question.id %}",
            data: {
                'voters': username,
                'email': $("#email1").val()
            },
            dataType: 'json',
            success: function (data) {
                $('#user-search').val("");
                $('#currentVoters').html($('#currentVoters').html() + "<option value=\"" + username + "\">" + username + "</option>");
            }
        });
    }

    $(function() {
        $("#user-search").autocomplete({
            source: function(request, response) {
                $.ajax({
                    url: "/polls/api/get_voters/",
                    dataType: "json",
                    data: {
                        term : request.term,
                        poll_id : {{question.id}}
                    },
                    success: function(data) {
                        response(data);
                    }
                });
            },
            minLength: 2,
            select: function( event, ui ) {
                add_voter(ui.item.value);
            }
        });
    });


    function toggleTextbox(){
        const textAreaForCustomMails = document.getElementById("textAreaForCustomMails");
        const customEmailsRadioButton = document.getElementById("customEmailsRadioButton");

        if (customEmailsRadioButton.checked) {
            // textAreaForCustomMails.style.display = 'block'; // Show the textbox
            textAreaForCustomMails.classList.remove('hide');
            textAreaForCustomMails.classList.add('show');
        } else {
            // textAreaForCustomMails.style.display = 'none'; // Hide the textbox
            textAreaForCustomMails.classList.remove('show');
            textAreaForCustomMails.classList.add('hide');
        }
    }

    function toggleMailDiv(emailNotification, mailNotificationDiv){

        if(emailNotification.checked) {
            mailNotificationDiv.classList.remove('hide');
            mailNotificationDiv.classList.add('show');
        } else {
            mailNotificationDiv.classList.remove('show');
            mailNotificationDiv.classList.add('hide');
        }
    }

    function populateDefaultText(mailSubjectElementId, mailContentElementId, subjectText, mailText){
        const mailSubEle = document.getElementById(mailSubjectElementId);
        const mailBodyEle = document.getElementById(mailContentElementId);

        mailSubEle.value = subjectText || '';
        mailBodyEle.innerHTML = mailText;
    }


    $(window).load(function(){
        function toggleSelectAll(selectAllCheckbox, multiSelect) {
        const options = multiSelect.options;
        const isChecked = selectAllCheckbox.checked;

        for (let i = 0; i < options.length; i++) {
            options[i].selected = isChecked;
            }
        }

        // Get the "Select All" checkbox and the multiple select element
        const selectAllCheckbox = document.getElementById('selectAll');
        const multiSelect = document.getElementById('currentVoters');

        // Add event listener to the "Select All" checkbox
        selectAllCheckbox?.addEventListener('change', () => {
            toggleSelectAll(selectAllCheckbox, multiSelect);
        });

        const radioButtons = document.querySelectorAll('input[name="recepients"]');
        radioButtons?.forEach(radio => {
            radio.addEventListener('change', toggleTextbox);
        });

        const emailNotification = document.getElementById('emailNotification');
        const mailNotificationDiv = document.getElementById("mailNotificationDiv");
        emailNotification?.addEventListener('change', ()=>{
            toggleMailDiv(emailNotification, mailNotificationDiv);
        });

        const emailNotificationToRemove = document.getElementById('emailNotificationToRemove');
        const mailNotificationDivToRemove = document.getElementById("mailNotificationDivToRemove");
        emailNotificationToRemove?.addEventListener('change', ()=>{
            toggleMailDiv(emailNotificationToRemove, mailNotificationDivToRemove);
        });

        // Populate default text into email body
        populateDefaultText('mailNotificationSubject', 'mailNotificationBody', 
        'You have been removed from {{ question.question_text }}', 'Some text');

        populateDefaultText('mailNotificationSubject1', 'mailNotificationBody1', 
        'You have been added to {{ question.question_text }}', 'Some text');
        
        var url = window.location;
        var protocol = url.protocol;
        var host = url.host; 
        populateDefaultText('mailSubject', 'mailBody', 
        'You have been added to {{ question.question_text }}', 'Sign up link: '+ protocol+host +'/auth/register/ \nLogin link: '+ protocol+host +'/polls/main');

        const emailNotificationToInvite = document.getElementById("emailNotificationToInvite");
        const emailDivForInvite = document.getElementById("emailDivForInvite");
        emailNotificationToInvite?.addEventListener('change', ()=>{
            toggleMailDiv(emailNotificationToInvite, emailDivForInvite);
        });

    });


</script>
<style>
.height-100{
 height: 100px;
}

.hide{
    display: none;
}

.show{
    display: block;
}

</style>

<div class="panel panel-default">
    <div class="panel-heading"><h4>Add multiple existing users/group:<h4></div>
    <div class="panel-body">
        <div class = "row">
        <div class="col-md-6">
            
            <form action="{% url 'polls:delvoter' question.id %}" method="post">
                <div style="display: flex; width: 100%;">
                    <div style="width: 70%;">
                        <label>Current Participants: </label> 
                    </div> 
                    {% if question.status == 1 %}
                    <div style="width: 30%;">
                        <div style="float: right;">
                            <label for="selectAll" style="margin-right: 5px;">Select all</label> 
                            <input type="checkbox" id="selectAll">
                        </div>
                    </div>
                    {% endif %}
                </div>
                {% csrf_token %}
                <select id="currentVoters" name="voters" class="form-control"  multiple style="height: 163px;">
                    {% for user in question.question_voters.all %}
                        <option value="{{ user.username }}">{{ user.username }}</option>
                    {% endfor %}
                </select>
                <br />
                {% if question.status == 1 %}
                    <label for="emailNotificationToRemove">Email announcement</label>
                    <input type="checkbox" name="email" id="emailNotificationToRemove" value="email" >
                    <!-- {% if question.emailDelete == True or question.emailDelete == None %} checked {% endif %} -->
                {% endif %}
                    <br />
                    <div id="mailNotificationDivToRemove" class="hide">
                        <input type="text" id="mailNotificationSubject" name="mailNotificationSubject" class="form-control" placeholder="Subject of the Mail" >
                        <br>
                        <textarea class="form-control" id="mailNotificationBody" name="mailNotificationBody" rows="9" placeholder="Content of the E-mail..." ></textarea>
                        <br>
                    </div>
                    {% if question.status == 1 %}
                    <input type="submit" class="btn btn-danger" value="Remove Participants">
                    {% endif %}
                
            </form> 
        </div>     
        <div class="col-md-6">
            <form id = "addUsersForm" action="{% url 'polls:addvoters' question.id %}" method="post">
                <div>
                    <label style="width: 30%;">Add Existing Users: </label>
                    {% csrf_token %}
                    <select name="voters" class="form-control multiple-select"  style="width: 100%;" multiple>
                        {% for user in users %}
                            <option value="{{ user.username }}">{{ user.username }}</option>
                        {% endfor %}
                    </select>
                    <br>
                    <input type="submit" value="Add Users" class="btn btn-success" style="margin-top: 15px;">
                </div>
                
                <br>

                <div>
                    <label style="width: 30%;">Add Group: </label>
                    <select name="groups" class="form-control multiple-select" style="width: 100%;" multiple >
                        {% for group in groups %}
                            {% if group.owner == request.user %}
                                <option value="{{ group.name }}">{{group.name}}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                    <br>
                    <input type="submit" class="btn btn-success" value="Add" style="margin-top: 15px;"/>
                    {% if question.status == 1 %}
                        <input type="submit" class="btn btn-danger" value="Remove" style="margin-top: 15px;" formaction="{% url 'groups:removegroupvoters' question.id %}">
                    {% endif %}
                </div>
                <br>
                <label for="email">Email announcement</label>
                <input type="checkbox" name="email" id="emailNotification" value="email" >
                <!-- {% if question.emailInvite == True or question.emailInvite == None %} checked {% endif %} -->
                <br>
                <div id="mailNotificationDiv" class="hide">
                    <input type="text" id="mailNotificationSubject1" name="mailNotificationSubject1" class="form-control" placeholder="Subject of the Mail" >
                    <br>
                    <textarea class="form-control" id="mailNotificationBody1" name="mailNotificationBody1" rows="9" placeholder="Content of the E-mail..." ></textarea>
                    <br>
                </div>
            </form>
            
        
        </div>
        
        </div>
    </div>
</div>
<br><br>

<div class="panel panel-default">
    
    <div class="panel-heading">Add voters with CSV:</div>
    <div class="panel-body">
        <form id="csvTextAreaForm" action="{% url 'polls:savelatestcsv' question.id %}" method="post">
            <div class="row">
                <div class="col-md-6">
                    
                        {% csrf_token %}
                        <div class="form-group">
                            <label for="csvTextArea">Enter the CSV in the below text area</label>
                            <textarea class="form-control" id="csvTextArea" name="votersCSVText" rows="9" style="height: 221px;">{{ recentCSVText }}</textarea>
                        </div>
                        <input type="submit" value="Submit CSV" class="btn btn-primary" style="margin-top: 0px;">
                    
                </div>
                <div class="col-md-6">
                    <label>Participants registered with OPRA: </label>
                    <select id="registeredVoters" name="registeredVoters" class="form-control" multiple>
                        {% for username in registeredUsers %}
                            <option value="{{ username }}">{{ username }}</option>
                        {% endfor %}
                    </select>
                    <br>
                    <label>Participants not registered with OPRA: </label>
                    <select id="unregisteredVoters" name="unregisteredVoters" class="form-control" multiple>
                        {% for username in unRegisteredUsers %}
                            <option value="{{ username }}">{{ username }}</option>
                        {% endfor %}
                    </select>
                </div> 
            </div>

            <br>

            <div>
                <label for="email2" style="margin-left: 20px; margin-bottom: 15px;">Email announcement</label>
                <input type="checkbox" name="email" id="emailNotificationToInvite" value="email" >
                <!-- {% if question.emailDelete == True or question.emailDelete == None %} checked {% endif %} onchange="this.form.submit()" -->
                <br />
            </div>

            <div class="panel panel-default hide" id="emailDivForInvite" style="width: 90%; margin:auto; margin-bottom: 15px;">
                <div class="panel-heading">Optionally send E-mail to participants:</div>
                <div class="panel-body">      
                    <div class="row">
                        <div class="col-md-12">
                            
                                {% csrf_token %}
                                <br>
                                <label>Recepients:</label> &nbsp;&nbsp;
                                <input type="radio" name="recepients" value="regVotersOnly"> Registered participants &nbsp;&nbsp;
                                <input type="radio" name="recepients" value="unregVotersOnly"> Unregistered participants &nbsp;&nbsp;
                                <input type="radio" name="recepients" value="allVoters" checked> Both &nbsp;&nbsp;
                                <input type="radio" name="recepients" value="customEmails" id = "customEmailsRadioButton"> Custom &nbsp;&nbsp;
                                <br>
                                <textarea id="textAreaForCustomMails" name="textAreaForCustomMails" class="form-control hide" placeholder="Emails sepereated by comma" style="height: 100px; margin-top: 20px;"></textarea>
                                <br>
                                <input type="text" id="mailSubject" name="mailSubject" class="form-control" placeholder="Subject of the Mail" required>
                                <br>
                                <textarea class="form-control" id="mailBody" name="mailBody" rows="9" placeholder="Content of the E-mail..." required></textarea>
                                <br>
                                <!-- <input type="submit" value="Send E-mail" class="btn btn-primary"> -->
                            
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
</div>

<br><br><br>


