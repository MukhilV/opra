{% extends 'polls/base.html' %}

{% block extra_head %}
<style type="text/css">
 #cy {
    width: 100%;
    height: 200px;
    border: 1px solid lightgray;
}   
</style>
<script src="http://js.cytoscape.org/js/cytoscape.min.js"></script>
<script>
function check()
{
    var choicesStr = "?";
    {% for poll in question.multipoll_set.all.0.questions.all %}
        {% if poll.multipollquestion_set.all.0.order < question.multipollquestion_set.all.0.order and poll.status == 2 %}    
            choicesStr += "poll{{poll.id}}=" + document.getElementById("dynamic_select{{poll.id}}").checked + "&"; 
        {% endif %}
    {% endfor %}
    
    window.location.href = "{% url 'polls:updatePrefGraph' question.id %}" + choicesStr; // redirect
    return false;
}
</script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <ol class="breadcrumb">
        <li>Multi-Poll</li>
        <li>{{ question.multipoll_set.all.0.title }}</li>
        <li class="active"> {{ question.question_text }}</li> 
    </ol>
    <form method="post" action="{% url 'polls:choosedependency' question.id %}" style="font-size:100%">
        {% csrf_token %}
        <h3>You are currently voting on {{question.question_text}} </h3>
        <hr />
        
        <div class="row">
            <div class="col-md-6">
                <h4 align="center">Your preferences for {{question.question_text}} depends on:</h4>

                <ul class="list-group">
                {% for poll in question.multipoll_set.all.0.questions.all %}
                    {% if poll.multipollquestion_set.all.0.order < question.multipollquestion_set.all.0.order and poll.status == 2 %}

                    <li class="list-group-item">
                        <div class="checkbox" align="center">
                            {% if prevCombination %}
                                <input type="checkbox" name="polls" value="{{poll.id}}" id="dynamic_select{{poll.id}}" class="pull-right" {% if poll in prevCombination.dependent_questions.all %} checked="checked" {% endif %} onclick="check()">
                            {% else %}
                                <input type="checkbox" name="polls" value="{{poll.id}}" id="dynamic_select{{poll.id}}" onclick="check();">
                            {% endif %}

                            <label  for="{{poll.id}}">      
                                {{ poll.question_text }} 
                            </label>
                        </div>  
                    </li>

                    <!--<div align="center"><label for="{{poll.id}}" style="font-size:1.2em">{{poll.question_text}}</label></div>
                    <p><input type="checkbox" name="polls" value="{{poll.id}}" align="center" class="form-control"> </p>-->

                    {% endif %}
                {% endfor%}
                </ul>
            </div>
            <div class="col-md-6">
                <div style="left: 50%;">
                    <div id="cy" ></div>
                </div>
            </div>
        
        </div>
        <br />
        <div align="center" style='font-size:100%'>
            <input type="submit" value="Next" class="btn btn-primary"/>
        </div>
    </form>
</div>

<script>
    var cy = cytoscape({
        container: document.getElementById('cy'),
        layout: {
            name: 'cose',
            padding: 10
        },

      style: cytoscape.stylesheet()
        .selector('node')
          .css({
            'width': 'mapData(weight, 40, 80, 20, 60)',
            'content': 'data(name)',
            'text-valign': 'center',
            'text-outline-width': 2,
            'text-outline-color': 'data(faveColor)',
            'background-color': 'data(faveColor)',
            'color': '#fff'
          })
        .selector(':selected')
          .css({
            'border-width': 3,
            'border-color': '#333'
          })
        .selector('edge')
          .css({
            'curve-style': 'bezier',
            'opacity': 0.666,
            'width': 'mapData(strength, 70, 100, 2, 6)',
            'target-arrow-shape': 'triangle',
            'source-arrow-shape': 'circle',
            'line-color': 'data(faveColor)',
            'source-arrow-color': 'data(faveColor)',
            'target-arrow-color': 'data(faveColor)'
          })
        .selector('edge.questionable')
          .css({
            'line-style': 'dotted',
            'target-arrow-shape': 'diamond'
          })
        .selector('.faded')
          .css({
            'opacity': 0.25,
            'text-opacity': 0
          }),


      elements: {
        nodes: [
         {% for row in pref_nodes %}
            {data: {id : '{{ row.id }}', name: '{{ row.label }}', weight: 10, faveColor: '#6FB1FC' } },
        {% endfor %}
        ],
        edges: [
         {% for row in pref_edges %}
            {data : { source: '{{ row.from }}', target: '{{ row.to }}', faveColor: '#6FB1FC', strength: 50 } },
        {% endfor %}
        ]
      },
    });
</script>
{% endblock %}
