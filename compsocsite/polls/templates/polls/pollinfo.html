{% extends 'polls/base.html' %}
{% block extra_head %}
<!--
  <link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
  <script src="//code.jquery.com/jquery-1.10.2.js"></script>
  <script src="//code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
-->

<script src='/static/js/qrcodejs/qrcode.js'></script>

<style>

/*
 * Global add-ons
 */
.sub-header {
  padding-bottom: 10px;
  border-bottom: 1px solid #eee;
}



/*
 * Sidebar
 */

/* Hide for mobile, show later */
.sidebar {
  display: none;
}
@media (min-width: 768px) {
  .sidebar {
    position: fixed;
    top: 51px;
    bottom: 0;
    left: 0;
    z-index: 1000;
    display: block;
    padding: 20px;
    overflow-x: hidden;
    overflow-y: auto; /* Scrollable contents if viewport is shorter than content. */
    background-color: #f5f5f5;
    border-right: 1px solid #eee;
  }
}

/* Sidebar navigation */
.nav-sidebar {
  margin-right: -21px; /* 20px padding + 1px border */
  margin-bottom: 20px;
  margin-left: -20px;
}
.nav-sidebar > li > a {
  padding-right: 20px;
  padding-left: 20px;
}
.nav-sidebar > .active > a,
.nav-sidebar > .active > a:hover,
.nav-sidebar > .active > a:focus {
  color: #fff;
  background-color: #428bca;
}


/*
 * Main content
 */

.main {
  padding: 20px;
}
@media (min-width: 768px) {
  .main {
    padding-right: 40px;
    padding-left: 40px;
  }
}
.main .page-header {
  margin-top: 0;
}


/*
 * Placeholder dashboard ideas
 */

.placeholders {
  margin-bottom: 30px;
  text-align: center;
}
.placeholders h4 {
  margin-bottom: 0;
}
.placeholder {
  margin-bottom: 20px;
}
.placeholder img {
  display: inline-block;
  border-radius: 50%;
}
 
img{
    width:40px;
}
img:hover{
    width:80px;
}
    
  #feedback { font-size: 1.4em; }
  #selectable .ui-selecting { background: #FECA40; }
  #selectable .ui-selected { background: #F39814; color: white; }
  #selectable { list-style-type: none; margin: 0; padding: 0; width: 60%; }
  #selectable li { margin: 3px; padding: 0.4em; font-size: 1.4em; height: 18px; }

  </style>
  <script>
  $(function() {
    $( "#selectable" ).selectable();
  });
  $( "#inviteButtonShow" ).click(function(){
    $("#invite").hide();
  });
  </script>




{% endblock %}
{% load staticfiles %}
{% block content %}



<div class="col-sm-3 col-md-2 sidebar">
    <ul class="nav nav-sidebar">
        {% if question.question_owner == request.user %}
        
            {%if question.m_poll == True %}
                <li> {{question.question_text}} <li>
                <li ><a href="{% url 'multipolls:mpollinfo' question.multipoll_set.all.0.id %}" >Go to the Multi Poll</a></li>
        
            {% endif %}
           
               <li {% if request.session.setting == 0 %} class="active" {% endif %}><a data-toggle="tab" href="#choices" >Choices</a></li>
                <li {% if request.session.setting == 2 %} class="active" {% endif %}><a data-toggle="tab" href="#algorithm">Algorithms</a></li>
                <li {% if request.session.setting == 3 %} class="active" {% endif %}><a data-toggle="tab" href="#visibility">Visibility</a></li>
                <li><a data-toggle="tab" href="#historyinfo">History</a></li>
       
           
            {%if question.m_poll == False %}
                <li {% if request.session.setting == 1 %} class="active" {% endif %}><a data-toggle="tab" href="#voters">Voters</a></li>
        
                <li {% if request.session.setting == 5 %} class="active" {% endif %}><a data-toggle="tab" href="#emailsetting">Email</a></li>
                <li {% if request.session.setting == 4 %} class="active" {% endif %}><a data-toggle="tab" href="#qr">Open/Close Poll</a></li>
                <li><a data-toggle="tab" href="{%url 'polls:pollinfo' question.id %}">Delete</a></li>
            {%endif%}
            
        {% else %}  
        <li class="active"><a data-toggle="tab" href="#general">General Info</a></li>
        <li><a data-toggle="tab" href="#historyinfo">History</a></li>
        <li><a data-toggle="tab" href="#quit">Quit</a></li>
        {% endif %}
        
    </ul>  
</div>




<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2">
<p>
{% if messages %}
<ul class="messages">
    {% for message in messages %}
    <div {% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>
        {{ message }}
    </div>
    {% endfor %}
</ul>
{% endif %}
</p>
</div>

<div class="tab-content">
{% if question.question_owner == request.user %}
    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main tab-pane {% if request.session.setting == 0 %}active{% endif %}" id="choices">
        <h3 class="page-header">Info and settings of {{ question.question_text }} </h3>
        
        {% include 'polls/_add_choice.html' %}
    </div>
    
    <!-- only for the regular vote-->
    {% if question.m_poll == False %}
    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main tab-pane {% if request.session.setting == 1 %}active{% endif %}" id="voters">
        <h3 class="page-header">Info and settings of {{ question.question_text }} </h3>

        {% include 'polls/_invite_voters.html' %}
    </div>
    {% endif %}

<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main tab-pane {% if request.session.setting == 2 %}active{% endif %}" id="algorithm">
    {% include 'polls/_set_algorithm.html' %}
</div>
            
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main tab-pane {% if request.session.setting == 3 %}active{% endif %}" id="visibility">
    {% include 'polls/_set_visibility.html' %}
</div>

<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main tab-pane {% if request.session.setting == 4 %}active{% endif %}" id="qr">
    <h3 class="page-header">Info and settings of {{ question.question_text }} </h3>
    {% if question.open == False %}
    <a href="{% url 'polls:openpoll' question.id %}" class="btn btn-success btn-ok">Open Poll</a>
    
    
    {% else %}
    <h4>Here is the QR Code for inviting users who have not logged in</h4>
    <div id="qrcode" style="margin-top:15px;">
        <img src="https://chart.googleapis.com/chart?chs=150x150&amp;cht=qr&amp;chl={{request.get_host}}{% url 'polls:detail' question.id %}" style="width:500px" />
    </div>
    <br >
    <a href="{% url 'polls:closepoll' question.id %}" class="btn btn-danger">Close Poll</a>

    {% endif %}
</div>


<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main tab-pane {% if request.session.setting == 5 %}active{% endif %}" id="emailsetting">
    <h3 class="page-header">Info and settings of {{ question.question_text }} </h3>

<div class="col-md-10">
    <form action="{% url 'polls:emailSettings' question.id %}" method="post">
        {% csrf_token %}
        <a href="#" id="inviteButtonShow">Edit Invite Message</a>
        <div class="col-md-6" id="invite">
            <label for="inviteSubject">Subject:</label> <br />
            <input type="text" class="form-control" id="inviteSubject" name="inviteSubject" value="{{emailInvite.subject}}" maxlength="100" size="100" />
            <label for="inviteMessage">Email body:</label> <br />
            <textarea type="text" class="form-control" id="inviteMessage" name="inviteMessage" value="" maxlength="500">{{emailInvite.message}}</textarea> <br />
            <label for="emailInvite">Send email when inviting voters</label>
            <input type="checkbox" name="emailInvite" id="emailInvite" value="email" {% if question.emailInvite == True %} checked {% endif %}>
        </div>
        <div class="col-md-6">
            <label for="deleteSubject">Subject:</label> <br />
            <input type="text" class="form-control" id="deleteSubject" name="deleteSubject" value="{{emailDelete.subject}}" maxlength="100" size="100" />
            <label for="deleteMessage">Email body:</label> <br />
            <textarea type="text" class="form-control" id="deleteMessage" name="deleteMessage" value="" maxlength="500">{{emailDelete.message}}</textarea> <br />
            <label for="emailDelete">Send email when deleting voters</label>
            <input type="checkbox" name="emailDelete" id="emailDelete" value="email" {% if question.emailDelete %} checked {% endif %}>
        </div>
        <div class="col-md-6">
            <label for="startSubject">Subject:</label> <br />
            <input type="text" class="form-control" id="startSubject" name="startSubject" value="{{emailStart.subject}}" maxlength="100" size="100" />
            <label for="startMessage">Email body:</label> <br />
            <textarea type="text" class="form-control" id="startMessage" name="startMessage" value="" maxlength="500">{{emailStart.message}}</textarea> <br />
            <label for="emailStart">Send email when the poll starts</label>
            <input type="checkbox" name="emailStart" id="emailStart" value="email" {% if question.emailStart %} checked {% endif %}>
        </div>
        <div class="col-md-6">
            <label for="stopSubject">Subject:</label> <br />
            <input type="text" class="form-control" id="stopSubject" name="stopSubject" value="{{emailStop.subject}}" maxlength="100" size="100" />
            <label for="stopMessage">Email body:</label> <br />
            <textarea type="text" class="form-control" id="stopMessage" name="stopMessage" value="" maxlength="500">{{emailStop.message}}</textarea> <br />
            <label for="emailStop">Send email when the poll stops</label>
            <input type="checkbox" name="emailStop" id="emailStop" value="email" {% if question.emailStop %} checked {% endif %}>
        </div>
        <input type="submit" value="Save Settings" class="btn btn-success">
    </form>
    <form action="{%url 'polls:emailNow' question.id%}" method="post">
        {% csrf_token %}
        <div class="col-md-6">
            <label for="subject">Subject:</label> <br />
            <input type="text" class="form-control" id="subject" name="subject" value="" maxlength="100" size="100" />
            <label for="message">Email body:</label> <br />
            <textarea type="text" class="form-control" id="message" name="message" value="" maxlength="500"></textarea> <br />
        </div>
        <input type="submit" value="Send Now" class="btn btn-success">
    </form>
    <form action="{%url 'polls:emailOptions' question.id%}" method="post">
        {% csrf_token %}
        <input type="submit" value="Send Options" class="btn btn-success">
    </form>
</div>
</div>

<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main tab-pane" id="delete">
    <h3 class="page-header">Info and settings of {{ question.question_text }} </h3>

<div class="panel panel-danger">
    <div class="panel-heading">Danger Zone</div>
    <div class="panel-body" align="center">
        <p>
            Make sure you are very certain before you make a decision. Once a poll is deleted, it cannot be recovered.<br /><br/>
            <span class="btn btn-danger" data-toggle="modal" data-target="#confirm-delete"><span class="glyphicon glyphicon-trash"></span> Delete this poll</span>
        </p>

        <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        Confirm Delete Poll
                    </div>
                    <div class="modal-body">
                        Are you absolutely sure you want to delete this poll? All voting information, settings, etc. will be erased permanently. 
                    </div>
                    <div class="modal-footer">
                        <a class="btn btn-danger btn-ok" href="{% url 'polls:delpoll' question.id %}">Yes</a>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
    
{% else %}
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main tab-pane" id="quit">
    <h3 class="page-header">Quit {{ question.question_text }} </h3>
    <div class="panel panel-danger">
    <div class="panel-heading">Danger Zone</div>
    <div class="panel-body" align="center">
        <p>
            Make sure you are very certain before you make a decision. Once you quit the poll, it cannot be recovered.<br /><br/>
            <span class="btn btn-danger" data-toggle="modal" data-target="#confirm-quit"><span class="glyphicon glyphicon-trash"></span> Quit this poll</span>
        </p>

        <div class="modal fade" id="confirm-quit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        Confirm Quit Poll
                    </div>
                    <div class="modal-body">
                        Are you absolutely sure you want to quit this poll? All voting information, settings, etc. will be erased permanently. 
                    </div>
                    <div class="modal-footer">
                        <a class="btn btn-danger btn-ok" href="{% url 'polls:quitpoll' question.id %}">Yes</a>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
    
<div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main tab-pane active" id="general">
              <h3 class="page-header">General info of {{ question.question_text }} </h3>

              <h4>Visibility Info</h4>
              {% if question.display_pref == 1 %}
                    <p> Everyone can see all information about this vote. </p>
              {% elif question.display_pref == 2 %}
                    <p> Only names of voters will be shown. </p>
              {% elif question.display_pref == 3 %}
                    <p> Only numbers of voters will be shown. </p>
              {% else %}
                    <p> You can only see your own vote.</p>
              {% endif %}

<hr />
              <h4>Voter info<h4>

              {% if question.display_pref == 1 %}
                <!-- Everyone can see all information about this vote. -->
                <table class="table table-bordered">
                    {% for user in users %}
                        {% if user in question.question_voters.all %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </table>
              {% elif question.display_pref == 2 %}
                <b> Voter Names: </b>
                <ul class="list-group">
                    {% for user in users %}
                        {% if user in question.question_voters.all %}
                        <li class="list-group-item">{{ user.username }}</li>
                        {% endif %}
                    {% endfor %}
                </ul>
              {% elif question.display_pref == 3 %}
                    <!-- Only numbers of voters will be shown. -->
                    <p>There are a total of {{question.question_voters.count}} unique voters.</p>
              
              {% else %}
                    <!-- You can only see your own vote.-->
                <table class="table table-bordered">
                    <tr>
                        <td>{{ request.user.username }}</td>
                        <td>{{ request.user.email }}</td>
                    </tr>
                </table>
              {% endif %}     
            </div>
            {% endif %}  
                  
                  
    <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main tab-pane" id="historyinfo">
      <h3 class="page-header">History votes of {{ question.question_text }} </h3>
        <!-- Display most recent vote -->
        {% if question.question_owner == request.user %}
            {% if latest_responses|length > 0 %}
                {% for response in latest_responses %}
                    {% if response.user %}
                    {% if response.user.first_name == "" %}
                        <b>{{ response.user.username }}</b> (last voted on {{ response.timestamp }}) <br />
                    {% else %}
                        {{ response.user.first_name }} {{ response.user.last_name }} (<a href="mailto:{{ response.user.email }}">{{ response.user.email }}</a>)
                        (last voted on {{ response.timestamp }}) <br />
                    {% endif %}
                    {% else %}
                        <b>(Anonymous) {{ response.anonymous_voter }}</b> (last voted on {{ response.timestamp }}) <br />
                    {% endif %}
                    <div >
                    {% for d in response.dictionary_set.all %}
                        {% for item in d.sorted_values %}
                        <button type="button" class="btn btn-default"> ({{ item.1 }}) {{ item.0 }} </button>
                        {% endfor %}
                    {% endfor %}
                    </div>
                    {% if response.comment %}
                        <p>Comment: {{response.comment}}</p>
                    {% endif %}
                {% endfor %} <!-- for response-->
                <br />
                <br />
                {% if previous_responses %}
                <button data-toggle="collapse" data-target="#history" class="btn btn-info" >Show/Hide More History</button>
                <div id="history" class="collapse">
                    <div class="well">
                    {% for response in previous_responses %}
                        <div class="btn-group">
                            {% if response.user %}
                            <b>{{ response.user.username }}</b> (last voted on {{ response.timestamp }}) <br />
                            {% else %}
                            <b>(Anonymous) {{ response.anonymous_voter }}</b> (last voted on {{ response.timestamp }}) <br />
                            {% endif %} 
                            {% for d in response.dictionary_set.all %}
                                {% for item in d.sorted_values %}
                            <button type="button" class="btn btn-default"> ({{ item.1 }}) {{ item.0 }} </button>
                                {% endfor %}
                            {% endfor %}
                            {% if response.comment %}
                        <p>Comment: {{response.comment}}</p>
                        {% endif %}
                        </div>
                        
                    {% endfor %}
                    </div>
                </div>
                {% endif %} <!--previous reoinses-->
        
            {% else %} 
                <p>No one has voted on this poll yet.</p>
            {% endif %} <!-- no response-->
            </div>
        {% else %} <!--question.question_owner != request.user-->
            {% if mostRecentResponse %}
                <div>
                    <b>{{ mostRecentResponse.user.username }}</b> (last voted on {{ mostRecentResponse.timestamp }}) <br /> 
                    {% for d in mostRecentResponse.dictionary_set.all %}
                        {% for item in d.sorted_values %}
                   <button type="button" class="btn btn-default">({{ item.1 }}) {{ item.0 }} </button>
                        {% endfor %}
                    {% endfor %}
                    {% if response.comment %}
                        <p>Comment: {{response.comment}}</p>
                    {% endif %}
                </div>
                <br />
                <br />
                {% if history %}
                <button data-toggle="collapse" data-target="#history" class="btn btn-info">Show/Hide History</button>
                <div id="history" class="collapse">
                    <div class="well">
                    {% for response in history %}
                        <ul class="list-group">
                            <b>{{ response.user.username }}</b> (last voted on {{ response.timestamp }}) <br /> 
                            {% for d in response.dictionary_set.all %}
                                {% for item in d.sorted_values %}
                            <li class="list-group-item">   ({{ item.1 }}) {{ item.0 }} </li>
                                {% endfor %}
                            {% endfor %}
                            {% if response.comment %}
                        <p>Comment: {{response.comment}}</p>
                        {% endif %}
                        </ul>
                    {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% else %}
                <p>You haven't voted on this poll yet.</p>
            {% endif %}
        {% endif %}
            
        {% if question.question_owner != request.user %}
            <!-- Display other user votes -->
            {% if question.display_pref == 1 %}
                <p>{{latest_responses|length}} / {{question.question_voters.count}} have voted.</p>
                <p>The owner allows everyone to see all votes cast.</p>
                {% for response in latest_responses %}
                {% if response.user %}
                    {% if response.user != request.user %}
                        <div class="btn-group">
                            <b>{{ response.user.username }}</b> (last voted on {{ response.timestamp }}) <br /> 
                            {% for d in response.dictionary_set.all %}
                                {% for item in d.sorted_values %}
                            <button type="button" class="btn btn-default"> {{ item.1 }}) {{ item.0 }} </button>
                                {% endfor %}
                            {% endfor %}
                            {% if response.comment %}
                        <p>Comment: {{response.comment}}</p>
                        {% endif %}
                        </div>
                    {% endif %}
                {% else %}
                <div class="btn-group">
                            <b>(Anonymous) {{ response.anonymous_voter }}</b> (last voted on {{ response.timestamp }}) <br /> 
                            {% for d in response.dictionary_set.all %}
                                {% for item in d.sorted_values %}
                            <button type="button" class="btn btn-default"> {{ item.1 }}) {{ item.0 }} </button>
                                {% endfor %}
                            {% endfor %}
                            {% if response.comment %}
                        <p>Comment: {{response.comment}}</p>
                        {% endif %}
                        </div>
                {% endif %}
                {% endfor %}
            {% elif question.display_pref == 2 %}
                <p>{{latest_responses|length}} / {{question.question_voters.count}} have voted.</p>
                <p>The following voters have voted on this poll:</p>
                <ul>
                    {% for response in latest_responses %}
                        <li>{{response.user.username}} (last voted on {{ response.timestamp }})</li>
                    {% endfor %}
                </ul>
            {% elif question.display_pref == 3 %}
                <p>{{latest_responses|length}} / {{question.question_voters.count}} have voted.</p>
            {% endif %}
        {% endif %}
        
        <br/>

    </div>

</div>


  
{% endblock %}