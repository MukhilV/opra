{% load mathfilters %}

<script>
$(function(){
    // bind change event to select
    {% for poll in combination.dependent_questions.all %}
        $('#dynamic_select' + '{{poll.id}}').on('change', function () {
            var choicesStr = "?";
            {% for poll in combination.dependent_questions.all %}
                choicesStr += "poll{{poll.id}}=" + $('#dynamic_select' + '{{poll.id}}').val() + "&"; 
            {% endfor %}

            window.location.href = "{% url 'multipolls:dependencyget' combination.id %}" + choicesStr; // redirect
            return false;
        });
    {% endfor %}
  });
</script>

<div>
    <form action="{% url 'multipolls:assignpreference' combination.id %}" method="post">
        {% csrf_token %}
        <div style="clear:both" class="col-md-12">
        {% for poll in combination.dependent_questions.all %}
            <div class="col-md-4 margin-panel-top">
                <h4>Poll {{ poll.question_text }}</h4>
                Select a choice for this dependent poll: <br />
                <select id="dynamic_select{{ poll.id }}" class="btn-group" name="{{ poll.id }}" size="{{poll.item_set.count}}">
                    
                        {% for item in poll.item_set.all %}
                            {% for row in colorArray %}
                            {% for color in row %}
                            {% if forloop.counter == forloop.parentloop.parentloop.counter and forloop.parentloop.counter == forloop.parentloop.parentloop.parentloop.counter %}

                            <option value="{{ item.item_text }}" class="btn btn-default" 
                                    {% if condition_items %}{% if item in condition_items %} selected {% endif %} 
                                    {% elif poll_choice_dict %}{% if item in poll_choice_dict.values %} selected {% endif %}
                                    {% else %}{% if forloop.counter == 1 %} selected {% endif %}{% endif %} 
                                    style='background-color: {{color}};'>{{item.item_text}}</option>
                            {% endif %}
                            {% endfor %}
                            {% endfor %}
                        {% endfor %}
             
                </select>
            </div>
        {% endfor %}
        </div>
        {% if request.flavour == "mobile" %}
        <div class="col-md-6 margin-panel-top">
        {% else %}
        <div class="col-md-6 margin-panel-top">
        {% endif %}
        
            <div class="panel panel-default panel-border">
                <div class="panel-heading" >
                    <b>Your preferences:</b>
                    {% if request.flavour == "mobile" %}
                        <button id="submitbutton" type="submit" onclick="submitPref();" class="submit-button-mobile" >
                            <span class="glyphicon glyphicon-upload" style="font-size:80%;color:white;">Submit</span>
                        </button>
                        
                        <button id="submitbutton" type="submit" onclick="submitPref();" class="btn btn-success" style ="float: right; display: none;">
                            Submit
                        </button>   
                    {% else %}
                            <a href="{% url 'multipolls:dependencyview' question.id %}?order=null" class="btn btn-danger reset-button">Clear</a>
                            <button id="submitbutton" type="submit" onclick="submitPref();" class="btn btn-success submit-button">
                                Submit
                            </button>
                    {% endif %}
                    
                    <input type="checkbox" name="default_pref"> Set as default preferences</input>
                    <input type="hidden" id="pref_order" name="pref_order" value=""/>
                </div>

                <div class="panel-body" >
                    <ul id="left-sortable" class="list-group droptrue">
                        {% if condition_responses %}
                            {% for selection in condition_responses %}
                                {% for item in question.item_set.all %}
                                    {% if selection.0 == item %}
                                    <ul class="choice1 empty" id="{{ selection.1|mul:2 }}"></ul>
                                    <div class="tier">{{ selection.1 }}</div>
                                    {% with prev=selection.1|mul:2 %}
                                        <ul class="choice1" id="{{ prev|add:1 }}">
                                    {% endwith %}
                                        <li style="padding:10px;" id="item{{ item.item_text }}">
                                            {% if selection.0.image %}
                                                <img class="item" src='/{{ selection.0.image.url }}'/>
                                            {% endif %}
                                            {% if item.imageURL != Null %}
                                                <img class="item" src='{{ item.imageURL }}'/>
                                            {% endif %}
                                            {{ selection.0 }}
                                            {% if item.item_description %}
                                                <span class="glyphicon glyphicon-info-sign pull-right" data-toggle="tooltip" data-placement="top" title="{{item.item_description}}"></span>
                                            {% endif %}
                                        </li>
                                    </ul>
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                            {% with prev=selection.1|mul:2 %}
                                <ul class="choice1 empty" id="{{ prev|add:2 }}"></ul>
                            {% endwith %}
                        {% endif %}
                    </ul> <!-- left-sortable-->
                </div>
                {% if request.flavour == "mobile" %}
                    <button onclick="javascript:window.location.href='{% url 'multipolls:dependencydetail' combination.id %}?order=null'; return false;" class="reset-button-mobile">
                        <a href="{% url 'multipolls:dependencydetail' combination.id %}?order=null" class="glyphicon glyphicon-trash redcolor" style="color:white;">Clear</a>
                    </button>       
                {% endif %}
            </div>
        </div>


        {% if request.flavour == "mobile" %}
        <div class="col-md-6 margin-panel-top">
        {% else %}
        <div class="col-md-6 margin-panel-top">
        {% endif %}
        
            <div class="panel panel-default panel-border">
                <div class="panel-heading">
                    <b>Remaining Options:</b>
                    
                    {% if request.flavour == "mobile" %}
                        <button onclick="moveAll(); return false;" class="move-all-button-mobile">
                            <span class="glyphicon glyphicon-arrow-up bluecolor" style="font-size:80%;float: center; color:white;">All</span>
                        </button>
                    {% else %}
                        <button onclick="moveAll(); return false;" class="btn btn-primary move-all-button" >
                           Move All
                        </button>
                    {% endif %}
                </div>
                <div class="panel-body">
                    <ul id="right-sortable" class="list-group">
                        {% if condition_responses == None %}
                        {% for item in items %}
                            <ul class="choice1 empty"></ul>
                            <div class="tier">{{ forloop.counter }}</div>
                            <ul class="choice1" onclick = "moveToPref(this)">
                                <li class="" id="item{{ item.item_text }}">
                                    {% if item.image %}
                                        <img class="item" src='/{{ item.image.url }}'/>
                                    {% endif %}
                                    {% if item.imageURL != Null %}
                                        <img class="item" src='{{ item.imageURL }}'/>
                                    {% endif %}
                                    {{ item.item_text }}
                                </li>
                            </ul>
                        {% endfor %}
                        <ul class="choice1 empty"></ul>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
        </div>
    </form>
</div>
    
<!-- Display confirmation message -->
<div class="row">
    <p>
    {% if messages %}
    <ul class="messages">
        {% for message in messages %}
        <div {% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}>
            {{ message }}  <a href="{% url 'polls:m_polls'%}">Return home</a>
        </div>
        {% endfor %}
    </ul>
    {% endif %}
    </p>       
</div>
<script>
    var wholeHeight1 = $('#left-sortable')[0].scrollHeight;
    var wholeHeight2 = $('#right-sortable')[0].scrollHeight;
    if (wholeHeight1 > wholeHeight2) {
        $('#right-sortable').css("height", wholeHeight1);
    } else {
        $('#left-sortable').css("height", wholeHeight2);
    }
    $('#left-sortable').sortable('refresh');
    $('#right-sortable').sortable('refresh');

</script>